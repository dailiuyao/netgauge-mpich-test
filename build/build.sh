#!/bin/bash
#SBATCH --nodes=1
#SBATCH --partition long
#SBATCH --time=0-00:29:00 
#SBATCH --ntasks-per-node=16 
#SBATCH --output=build_netgauge%j.stdout    
#SBATCH --job-name=build_netgauge   

# ---[ Script Setup ]---

set -e

#module load cuda
#CUDA_HOME="/opt/spack/opt/spack/linux-rhel8-icelake/gcc-8.4.1/cuda-11.8.0-fdqi76f2fma5m7wyc2ngmbkspssgwr2c"
CUDA_HOME="/opt/nvidia/hpc_sdk/Linux_x86_64/21.9/cuda"
export CUDA_HOME
export PATH="${CUDA_HOME}/include:$PATH"
export LD_LIBRARY_PATH="${CUDA_HOME}/lib64:$LD_LIBRARY_PATH"


export NCCL_HOME=/home/ldai8/NCCL/deps-nccl/nccl/build
# export NCCL_TEST_HOME=/home/ldai8/NCCL/deps-nccl/nccl-tests/build
export PATH="${NCCL_HOME}/include:$PATH"
export LD_LIBRARY_PATH="${NCCL_HOME}/lib:$LD_LIBRARY_PATH"

module load mpich/3.4.2-nvidiahpc-21.9-0
MPI_HOME="/opt/apps/mpi/mpich-3.4.2_nvidiahpc-21.9-0"
export MPI_HOME
export PATH="${MPI_HOME}/include:$PATH"
export LD_LIBRARY_PATH="${MPI_HOME}/lib:$LD_LIBRARY_PATH"

# for the shared library generated by myself

export LD_LIBRARY_PATH="/home/ldai8/software/Netgauge/libnccl:$LD_LIBRARY_PATH"


echo "########## ENVIRONMENT ########"
echo "NCCL_LOCATION=${NCCL_HOME}"



cd /home/ldai8/software/Netgauge

# make clean

# git clone https://github.com/dailiuyao/Netgauge.git

# ./configure --prefix=/opt/apps/mpi/mpich-3.4.2_nvidiahpc-21.9-0
# ./configure --with-mpi=/opt/apps/mpi/mpich-3.4.2_nvidiahpc-21.9-0 

 ./configure \
  CFLAGS='-I/home/ldai8/software/Netgauge/libnccl -I/home/ldai8/NCCL/deps-nccl/nccl/build/include -I/opt/nvidia/hpc_sdk/Linux_x86_64/21.9/cuda/include -I/opt/apps/mpi/mpich-3.4.2_nvidiahpc-21.9-0/include ' \
  CPPFLAGS='-I/home/ldai8/software/Netgauge/libnccl -I/home/ldai8/NCCL/deps-nccl/nccl/build/include -I/opt/nvidia/hpc_sdk/Linux_x86_64/21.9/cuda/include -I/opt/apps/mpi/mpich-3.4.2_nvidiahpc-21.9-0/include ' \
  CXXFLAGS='-I/home/ldai8/software/Netgauge/libnccl -I/home/ldai8/NCCL/deps-nccl/nccl/build/include -I/opt/nvidia/hpc_sdk/Linux_x86_64/21.9/cuda/include -I/opt/apps/mpi/mpich-3.4.2_nvidiahpc-21.9-0/include ' \
  LDFLAGS='-L/home/ldai8/software/Netgauge/libnccl -lMyNcclCode -L/home/ldai8/NCCL/deps-nccl/nccl/build/lib -lnccl -L/opt/nvidia/hpc_sdk/Linux_x86_64/21.9/cuda/lib64 -lcudart -L/opt/apps/mpi/mpich-3.4.2_nvidiahpc-21.9-0/lib -lmpi ' 


sed -i 's/CXXFLAGS = -g -O2/CXXFLAGS = -g/' Makefile

sed -i 's/CFLAGS =/CFLAGS = -g/' Makefile

sed -i 's/CPPFLAGS =/CPPFLAGS = -g/' Makefile 
  
sed -i 's/CXXFLAGS = -g -O2/CXXFLAGS = -g/' /home/ldai8/software/Netgauge/wnlib/Makefile 
  

# sed -i 's/mpicc/mpic++/' Makefile

# sed -i 's/mpicxx/mpic++/' Makefile

# sed -i 's/mpicc/mpic++/' /home/ldai8/software/Netgauge/wnlib/Makefile

# sed -i 's/mpicxx/mpic++/' /home/ldai8/software/Netgauge/wnlib/Makefile  

#  ./configure \
#   LDFLAGS='-L/home/ldai8/software/Netgauge/libnccl -lMyNcclCode ' \
#   --with-mpi

# sed -i 's/CXXFLAGS = -g -O2/CXXFLAGS = -g -I\/home\/ldai8\/software\/Netgauge\/libnccl -L\/home\/ldai8\/software\/Netgauge\/libnccl -lMyNcclCode/' Makefile

# sed -i 's/CFLAGS =/CFLAGS = -g -I\/home\/ldai8\/software\/Netgauge\/libnccl -L\/home\/ldai8\/software\/Netgauge\/libnccl -lMyNcclCode/' Makefile

# sed -i 's/CPPFLAGS =/CPPFLAGS = -g -I\/home\/ldai8\/software\/Netgauge\/libnccl -L\/home\/ldai8\/software\/Netgauge\/libnccl -lMyNcclCode/' Makefile 
  
# sed -i 's/CXXFLAGS = -g -O2/CXXFLAGS = -g -I\/home\/ldai8\/software\/Netgauge\/libnccl -L\/home\/ldai8\/software\/Netgauge\/libnccl -lMyNcclCode/' /home/ldai8/software/Netgauge/wnlib/Makefile 
  
  
  #LDFLAGS='-L/home/ldai8/NCCL/deps-nccl/nccl/build/lib -lnccl -L/opt/spack/opt/spack/linux-rhel8-icelake/gcc-8.4.1/cuda-11.8.0-fdqi76f2fma5m7wyc2ngmbkspssgwr2c/lib64 -lcudart -L/opt/apps/mpi/mpich-3.4.2_nvidiahpc-21.9-0/lib -lmpi' \

#  LDFLAGS='-L /usr/local/lib64 -L /home/ldai8/NCCL/deps-nccl/nccl/build/lib -L /opt/spack/opt/spack/linux-rhel8-icelake/gcc-8.4.1/cuda-11.8.0-fdqi76f2fma5m7wyc2ngmbkspssgwr2c/lib64'\
#  LDFLAGS='-L /home/ldai8/NCCL/deps-nccl/nccl/build/lib' 

# sed -i 's/CXXFLAGS = -g -O2/CXXFLAGS = -g -L\/home\/ldai8\/NCCL\/deps-nccl\/nccl\/build\/lib -lnccl/' Makefile

# sed -i 's/CFLAGS =/CFLAGS = -g -L\/home\/ldai8\/NCCL\/deps-nccl\/nccl\/build\/lib -lnccl/' Makefile

# sed -i 's/CPPFLAGS =/CPPFLAGS = -g -L\/home\/ldai8\/NCCL\/deps-nccl\/nccl\/build\/lib -lnccl/' Makefile

# sed -i 's/CXXFLAGS = -g -O2/CXXFLAGS = -g -L\/home\/ldai8\/NCCL\/deps-nccl\/nccl\/build\/lib -lnccl/' /home/ldai8/software/Netgauge/wnlib/Makefile

# sed -i 's/DEFAULT_INCLUDES = -I\./DEFAULT_INCLUDES = -I\. -I\/home\/ldai8\/NCCL\/deps-nccl\/nccl\/build\/include -I\/opt\/spack\/opt\/spack\/linux-rhel8-icelake\/gcc-8.4.1\/cuda-11.8.0-fdqi76f2fma5m7wyc2ngmbkspssgwr2c\/include/' Makefile

make